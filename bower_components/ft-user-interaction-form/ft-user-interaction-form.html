<!--
Copyright 2017 FileThis, Inc.

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
--><link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<!--<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">-->  <!-- causes vulcanize to look for web-animations-next-lite.min.js -->
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">

<link rel="import" href="ft-user-interaction-request-parser-2_0_0.html">
<link rel="import" href="ft-user-interaction-request-parser-1_0_0.html">

<link rel="import" href="ft-user-interaction-response-generator-2_0_0.html">
<link rel="import" href="ft-user-interaction-response-generator-1_0_0.html">

<link rel="import" href="ft-user-interaction-form-generator-2_0_0.html">
<link rel="import" href="ft-user-interaction-form-generator-1_0_0.html">


<!--

This element dynamically renders a user dialog form by parsing a FileThis user interaction request, as JSON.
When the user enters data on the form, and clicks a button that submits the dialog, the resulting FileThis
user interaction response, as JSON, will be put into the response property.

You can get intermediate responses by calling the generateResponse() method.

@demo demo/index.html
 -->
<dom-module id="ft-user-interaction-form">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning"></style>

        <style>
            :host {
                display:block;
            }
        </style>

        <!-- Form -->
        <div id="form" class="vertical layout" on-button-clicked="_onButtonClicked">
        </div>

    </template>

    <script>
        Polymer
        ({
            is: 'ft-user-interaction-form',

            /**
             * Fired when user hits a button that asks to submit the user interaction response.
             *
             * @event submit-response
             * @param {Object} response The user interaction response generated by what the user entered into the dialog form.
             */

            /**
             * Fired when the request property changes.
             *
             * @event request-changed
             * @param {Object} request The current request, as JSON.
             */

            /**
             * Fired when the response property changes.
             *
             * @event response-changed
             * @param {Object} request The current response, as JSON.
             */

            /**
             * Fired when any data on the form is changed by the user â€”text entry, radiobutton, etc.
             *
             * @event entered-data-changed
             */

            /**
             * Fired when any button on the form is clicked by the user.
             *
             * @event button-clicked
             * @param {
             *    {
             *       id: String,
             *       action: String,
             *       submit: Boolean
             *    }
             * }
             */

            properties:
            {
                /** Version of user interaction schema to use. */
                version:
                {
                    type: Object,  // JSON
                    notify: true,
                    value: "2.0.0",
                    observer: "_onVersionChanged"
                },

                /** User interaction request as JSON, to be rendered as a form. */
                request:
                {
                    type: Object,  // JSON
                    notify: true,
                    value: null,
                    observer: "_onRequestChanged"
                },

                /** User interaction response as JSON, extracted from data entered into the form. */
                response:
                {
                    type: String,
                    notify: true,
                    value: null,
                    observer: "_onResponseChanged"
                },

                /** Internal. Associates each form widget id to its element. Used when generating response. */
                _widgetMap:
                {
                    type: Object,
                    notify: false,
                    value: {}
                }
            },

            _requestParser: null,
            _formGenerator: null,
            _responseGenerator: null,

            _clear: function()
            {
                this._widgetMap = {};
                this._clearResponse();
            },

            _onVersionChanged: function(to, from)
            {
                this._clear();

                switch (this.version)
                {
                    case "1.0.0":
                        this._requestParser = new InteractionRequestParser_1_0_0();
                        this._formGenerator = new InteractionFormGenerator_1_0_0(this, this.$.form, this._widgetMap, "325px");
                        this._responseGenerator = new InteractionResponseGenerator_1_0_0(this._widgetMap);
                        break;

                    case "2.0.0":
                        this._requestParser = new InteractionRequestParser_2_0_0();
                        this._formGenerator = new InteractionFormGenerator_2_0_0(this, this.$.form, this._widgetMap, "325px");
                        this._responseGenerator = new InteractionResponseGenerator_2_0_0(this._widgetMap);
                        break;

                    default:
                        throw new IllegalArgumentException("Unknown user interaction schema version: " + this.version);
                }
            },

            _onRequestChanged: function(to, from)
            {
                this._clear();
                this._generateForm();

                this.fire('request-changed', this.request);
            },

            _onResponseChanged: function(to, from)
            {
                this.fire('response-changed', this.response);
            },

            _clearResponse: function()
            {
                this.response = null;
            },

            _generateForm: function()
            {
                if (this._formGenerator == null)
                    return;
                if (this.request == null)
                    this._formGenerator.clear();
                else
                    this._requestParser.parse(this.request, this._formGenerator);
            },

            /** You may call this at will to generate a partial response from what has been entered into the form, so far */
            generateResponse: function()
            {
                if (this._responseGenerator == null)
                    return;
                this._requestParser.parse(this.request, this._responseGenerator);
                this.response = this._responseGenerator.getResponse();
            },

            _onButtonClicked: function(event)
            {
                // If a submit button was clicked, generate the response, and fire a specific event
                if (event.detail.submit)
                {
                    this.generateResponse();
                    this.fire('submit-response', this.response);
                }
            }

        });
    </script>

</dom-module>
