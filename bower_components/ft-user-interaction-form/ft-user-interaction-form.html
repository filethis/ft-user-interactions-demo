<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-label/iron-label.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-checkbox/paper-checkbox.html">
<!--<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">-->  <!-- causes vulcanize to look for web-animations-next-lite.min.js -->
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-material/paper-material.html">
<link rel="import" href="../paper-radio-button/paper-radio-button.html">
<link rel="import" href="../paper-radio-group/paper-radio-group.html">


<!--

This element dynamically renders a user dialog form by parsing a FileThis user interaction request, as JSON.
When the user enters data on the form, and clicks a button that commits the dialog, the resulting FileThis
user interaction response, as JSON, will be put into the response property.

You can get intermediate responses by calling the generateResponse() method.

@demo demo/index.html
 -->
<dom-module id="ft-user-interaction-form">

    <style include="iron-flex iron-flex-alignment"></style>

    <template>

        <!-- Form -->
        <div id="form"
             on-button-clicked="_onButtonClicked"
             on-entered-data-changed="_onEnteredDataChanged">
        </div>

    </template>


    <!-- ===================================== 2.0.0 ===================================== -->

    <!-- Request Parser 2.0.0 -->
    <script>
        function InteractionRequestParser_2_0_0()
        {
            this.generator = null;
        }

        // Main entry point
        InteractionRequestParser_2_0_0.prototype.parse = function(request, generator)
        {
            this.generator = generator;

            this.generator.begin();

            this.parseTitle(request);

            var partCount = request["2.0.0"].parts.length;
            for (var partIndex = 0; partIndex < partCount; partIndex++)
            {
                var part = request["2.0.0"].parts[partIndex];

                switch (part.kind)
                {
                    case "static-text":
                        this.parseStaticText(request, part);
                        break;
                    case "text-input":
                        this.parseTextInput(request, part);
                        break;
                    case "choices":
                        this.parseChoices(request, part);
                        break;
                }
            }

            this.generator.end();
        };

        InteractionRequestParser_2_0_0.prototype.parseTitle = function(request)
        {
            var title = request["2.0.0"].title;
            this.generator.generateTitle(title);
        };

        InteractionRequestParser_2_0_0.prototype.parseStaticText = function(request, part)
        {
            var id = part.id;
            var text = part.text;

            this.generator.generateStaticText(id, text);
        };

        InteractionRequestParser_2_0_0.prototype.parseTextInput = function(request, part)
        {
            var id = part.id;
            var label = part.label;
            var sensitive = part.sensitive;

            this.generator.generateTextInput(id, label, sensitive);
        };

        InteractionRequestParser_2_0_0.prototype.parseChoices = function(request, part)
        {
            var id = part.id;
            var label = part.label;

            var suggestedWidgetType = part.suggestedWidgetType;

            var defaultChoiceId = null;
            if (part.defaultChoiceId !== undefined)
                defaultChoiceId = part.defaultChoiceId;

            var choices = [];
            var choicesCount = part.choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = part.choices[choicesIndex];

                var choiceId = choice.id;
                var choiceLabel = choice.label;

                choices.push({id:choiceId, label:choiceLabel});
            }

            this.generator.generateChoices(id, label, choices, defaultChoiceId, suggestedWidgetType);
        };
    </script>


    <!-- Form Generator 2.0.0 -->
    <script>
        function InteractionFormGenerator_2_0_0(polymer, view, widgetMap, maxWidth)
        {
            this.polymer = polymer;
            this.rootView = view;
            this.widgetMap = widgetMap;
            this.maxWidth = maxWidth;

            this.commitButton = null;
        }

        InteractionFormGenerator_2_0_0.prototype.getResponse = function()
        {
            return this.response;
        };

        InteractionFormGenerator_2_0_0.prototype.clear = function()
        {
            // Clean up from the last time we used the root view
            this.rootView.removeEventListener('keyup', this.onKeyUp.bind(this));
            this.rootView.removeEventListener('paper-radio-group-changed', this.onPaperRadioGroupChanged.bind(this));
            this.rootView.removeEventListener('change', this.onChange.bind(this));

            if (this.cancelButton)
            {
                // this.cancelButton.removeEventListener('click', this.onCancelButtonClicked.bind(this));
                this.cancelButton = null;
            }

            if (this.commitButton)
            {
                // this.commitButton.removeEventListener('click', this.onCommitButtonClicked.bind(this));
                this.commitButton = null;
            }

            // Remove all children of the root view
            for (var child = Polymer.dom(this.rootView).lastChild;
                 child != null;
                 child = Polymer.dom(this.rootView).lastChild)
            {
                Polymer.dom(this.rootView).removeChild(child);
            }
            Polymer.dom.flush();

            // Clear the widget map
            for (var property in this.widgetMap)
            {
                if (this.widgetMap.hasOwnProperty(property))
                    delete this.widgetMap[property];
            }
        };

        InteractionFormGenerator_2_0_0.prototype.begin = function()
        {
            this.clear();

            this.generating = true;

            // Add listener to all user-input changes so we can validate the form and enable the "OK" button
            this.rootView.addEventListener('keyup', this.onKeyUp.bind(this));
            this.rootView.addEventListener('paper-radio-group-changed', this.onPaperRadioGroupChanged.bind(this));
            this.rootView.addEventListener('change', this.onChange.bind(this));

            this.rootView.style.minWidth = "300px";
            this.rootView.style.padding = "16px";
        };

        InteractionFormGenerator_2_0_0.prototype.end = function()
        {
            // Horizontal container for cancel and commit buttons
            var div = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(div);
            this.polymer.toggleClass("layout", true, div);
            this.polymer.toggleClass("horizontal", true, div);
            div.style.width = "100%";
            div.style.paddingTop = "20px";

            // Spacer to push button to right
            var springSpacer = document.createElement('div');
            Polymer.dom(div).appendChild(springSpacer);
            springSpacer.style.width = "100%";

            // Cancel button
            var cancelButton = document.createElement('paper-button');
            cancelButton.addEventListener('click', this.onButtonClicked.bind(this, true));
            Polymer.dom(div).appendChild(cancelButton);
            cancelButton.raised = true;
            cancelButton.style.width = "60px";
            cancelButton.style.height = "36px";
            cancelButton.style.background = "white";
            Polymer.dom(cancelButton).textContent = 'Cancel';
            this.cancelButton = cancelButton;

            // Spacer between buttons
            var spacer = document.createElement('div');
            Polymer.dom(div).appendChild(spacer);
            spacer.style.width = "20px";

            // Commit button
            var commitButton = document.createElement('paper-button');
            commitButton.addEventListener('click', this.onButtonClicked.bind(this, false));
            Polymer.dom(div).appendChild(commitButton);
            commitButton.raised = true;
            commitButton.style.width = "60px";
            commitButton.style.height = "36px";
            commitButton.style.background = "white";
            Polymer.dom(commitButton).textContent = 'OK';
            this.commitButton = commitButton;

            // Flush all changes
            Polymer.dom.flush();

            this.generating = false;

            this.validate();
        };

        InteractionFormGenerator_2_0_0.prototype.generateId = function(id)
        {
            // Ignore. No need to display this.
        };

        InteractionFormGenerator_2_0_0.prototype.generateTitle = function(title)
        {
            var element = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(element);
            element.innerHTML = title;
            element.style.paddingBottom = "10px";
            element.style.fontSize = "20pt;";
        };

        InteractionFormGenerator_2_0_0.prototype.generateStaticText = function(id, text)
        {
            var element = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(element);

            element.innerHTML = text;
            element.style.maxWidth = this.maxWidth;
            element.style.paddingTop = "12px";

            this.widgetMap[id] = element;
        };

        InteractionFormGenerator_2_0_0.prototype.generateTextInput = function(id, label, sensitive)
        {
            var element = document.createElement('paper-input');
            Polymer.dom(this.rootView).appendChild(element);

            element.label = label;
            element.style.paddingTop = "12px";

            var type;
            if (sensitive)
                type = 'password';
            else
                type = 'text';
            element.type = type;

            this.widgetMap[id] = element;
        };

        InteractionFormGenerator_2_0_0.prototype.generateChoices = function(id, label, choices, defaultChoiceId, suggestedWidgetType)
        {
            // Vertical container
            var container = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(container);
            this.polymer.toggleClass("layout", true, container);
            this.polymer.toggleClass("vertical", true, container);
            container.style.width = "100%";
            container.style.paddingTop = "12px";

            // Create choice group
            switch (suggestedWidgetType)
            {
                // Short lists
                case "radiobutton":
                case "list-box":  // TODO
                default:
                    this.generateRadiobuttonChoices(id, label, choices, defaultChoiceId, container);
                    break;

                // Long lists
                case "combo-box":
                case "drop-down-menu":  // TODO
                    this.generateMenuChoices(id, label, choices, defaultChoiceId, container);
                    break;
            }
        };

        InteractionFormGenerator_2_0_0.prototype.generateRadiobuttonChoices = function(id, label, choices, defaultChoiceId, container)
        {
            // Group label
            var groupLabel = document.createElement('div');
            Polymer.dom(container).appendChild(groupLabel);
            groupLabel.innerHTML = label;
            groupLabel.style.maxWidth = this.maxWidth;
            groupLabel.style.marginBottom = "12px";
            groupLabel.style.paddingTop = "12px";

            // Group
            var group = document.createElement('paper-radio-group');
            group.id = "choice-group";
            Polymer.dom(container).appendChild(group);
            group.style.maxWidth = this.maxWidth;
            this.widgetMap[id] = group;

            // Choices in group
            var choicesCount = choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = choices[choicesIndex];

                // Radiobutton
                var radiobutton = document.createElement('paper-radio-button');
                Polymer.dom(group).appendChild(radiobutton);
                radiobutton.id = choice.id;
                radiobutton.name = choice.id;
                Polymer.dom(radiobutton).textContent = choice.label;
                radiobutton.style.paddingLeft = "20px";

                // If a default choice was specified and this is it, select this radiobutton
                if (defaultChoiceId && radiobutton.id == defaultChoiceId)
                    group.select(choice.id);

                this.widgetMap[choice.id] = radiobutton;
            }
        };

        InteractionFormGenerator_2_0_0.prototype.generateMenuChoices = function(id, label, choices, defaultChoiceId, container)
        {
            // Dropdown menu
            var dropdownMenu = document.createElement('select');
            Polymer.dom(container).appendChild(dropdownMenu);
            dropdownMenu.style.maxWidth = this.maxWidth;
            dropdownMenu.style.paddingTop = "12px";
            dropdownMenu.label = label;
            this.widgetMap[id] = dropdownMenu;

            // Items
            var choicesCount = choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = choices[choicesIndex];

                var item = document.createElement('option');
                Polymer.dom(dropdownMenu).appendChild(item);
                item.value = choice.id;
                item.text = choice.label;

                // If a default choice was specified and this is it, select this item
                if (defaultChoiceId && item.value == defaultChoiceId)
                    dropdownMenu.value = item.value;

                this.widgetMap[choice.id] = null;  // Unlike radiobutton clusters, there is no widget for each menu choice
            }
        };

        InteractionFormGenerator_2_0_0.prototype.onButtonClicked = function(event, cancels)
        {
            this.fire(this.rootView, 'button-clicked');
        };

        InteractionFormGenerator_2_0_0.prototype.onKeyUp = function(event)
        {
            this.onUserInput();
        };

        InteractionFormGenerator_2_0_0.prototype.onPaperRadioGroupChanged = function(event)
        {
            this.onUserInput();
        };

        InteractionFormGenerator_2_0_0.prototype.onChange = function(event)
        {
            this.onUserInput();
        };

        InteractionFormGenerator_2_0_0.prototype.onUserInput = function()
        {
            // Suppress when we are compiling
            if (this.generating)
                return;

            this.validate();

            this.fire(this.rootView, 'entered-data-changed');
        };

        InteractionFormGenerator_2_0_0.prototype.validate = function()
        {
            if (this.commitButton == null)
                return;

            var enabled = true;

            if (enabled)
                enabled = this.allTextInputsValid();
            if (enabled)
                enabled = this.allRadiobuttonGroupsValid();
            if (enabled)
                enabled = this.allMenusValid();

            this.commitButton.disabled = !enabled;
        };

        InteractionFormGenerator_2_0_0.prototype.allTextInputsValid = function()
        {
            // For each text input in the form
            var elements = Polymer.dom(this.rootView).querySelectorAll("paper-input");
            var count = elements.length;
            for (var index = 0; index < count; index++)
            {
                var element = elements[index];
                if (element.value.length == 0)
                    return false;
            }
            return true;
        };

        InteractionFormGenerator_2_0_0.prototype.allRadiobuttonGroupsValid = function()
        {
            // For each radiobutton group in the form
            var radioButtonGroups = Polymer.dom(this.rootView).querySelectorAll("#choice-group");
            var groupCount = radioButtonGroups.length;
            for (var groupIndex = 0; groupIndex < groupCount; groupIndex++)
            {
                var radioButtonGroup = radioButtonGroups[groupIndex];

                // Is one of the radiobuttons in this group selected?
                var someRadiobuttonIsSelected = false;
                var radiobuttons = Polymer.dom(radioButtonGroup).querySelectorAll("paper-radio-button");
                var radiobuttonCount = radiobuttons.length;
                for (var radiobuttonIndex = 0; radiobuttonIndex < radiobuttonCount; radiobuttonIndex++)
                {
                    var radioButton = radiobuttons[radiobuttonIndex];
                    if (radioButton.checked)
                    {
                        someRadiobuttonIsSelected = true;
                        break;
                    }
                }
                if (!someRadiobuttonIsSelected)
                    return false;
            }
            return true;
        };

        InteractionFormGenerator_2_0_0.prototype.allMenusValid = function()
        {
            // For each menu in the form
            var menus = Polymer.dom(this.rootView).querySelectorAll("select");
            var count = menus.length;
            for (var index = 0; index < count; index++)
            {
                var menu = menus[index];
                if (menu.value == null)
                    return false;
            }
            return true;
        };

        InteractionFormGenerator_2_0_0.prototype.fire = function(element, eventName)
        {
            var event;

            if (document.createEvent)
            {
                event = document.createEvent("HTMLEvents");
                event.initEvent(eventName, true, true);
            }
            else
            {
                event = document.createEventObject();
                event.eventType = eventName;
            }

            event.eventName = eventName;

            if (document.createEvent)
                element.dispatchEvent(event);
            else
                element.fireEvent("on" + event.eventType, event);
        };    </script>


    <!-- Response Generator 2.0.0 -->
    <script>
        function InteractionResponseGenerator_2_0_0(widgetMap)
        {
            this.widgetMap = widgetMap;

            this.responseParts = null;

            this.response = null;
        }

        InteractionResponseGenerator_2_0_0.prototype.getResponse = function()
        {
            return this.response;
        };

        InteractionResponseGenerator_2_0_0.prototype.begin = function()
        {
            this.responseParts = [];
        };

        InteractionResponseGenerator_2_0_0.prototype.end = function()
        {
            this.response =
            {
                "version": "2.0.0",
                "id": this.requestId.toString(),
                "parts": this.responseParts
            };
        };

        InteractionResponseGenerator_2_0_0.prototype.generateId = function(id)
        {
            this.requestId = id;
        };

        InteractionResponseGenerator_2_0_0.prototype.generateTitle = function(title)
        {
            // Nothing to do
        };

        InteractionResponseGenerator_2_0_0.prototype.generateStaticText = function(id, text)
        {
            // Nothing to do
        };

        InteractionResponseGenerator_2_0_0.prototype.generateTextInput = function(id, label, sensitive)
        {
            var field = this.widgetMap[id];
            var value = field.value;

            this.responseParts.push({id:id, value:value});
        };

        InteractionResponseGenerator_2_0_0.prototype.generateChoices = function(id, label, choices, defaultChoiceId, suggestedWidgetType)
        {
            var group = this.widgetMap[id];

            switch (suggestedWidgetType)
            {
                // Short lists
                case "radiobutton":
                case "list-box":  // TODO
                default:
                    group = this.generateRadiobuttonChoices(id, label, choices);
                    break;

                // Long lists
                case "combo-box":
                case "drop-down-menu":  // TODO
                    group = this.generateMenuChoices(id, label, choices);
                    break;
            }
        };

        // Private
        InteractionResponseGenerator_2_0_0.prototype.generateRadiobuttonChoices = function(id, label, choices)
        {
            var group = this.widgetMap[id];

            // Find the selected choice
            var choicesCount = choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = choices[choicesIndex];
                var choiceId = choice.id;
                var radiobutton = this.widgetMap[choiceId];
                if (radiobutton.checked)
                {
                    this.responseParts.push({id:id, value:choiceId});
                    return;
                }
            }
        };

        // Private
        InteractionResponseGenerator_2_0_0.prototype.generateMenuChoices = function(id, label, choices)
        {
            var menu = this.widgetMap[id];
            var choiceId = menu.value;

            this.responseParts.push({id:id, value:choiceId});
        };
    </script>


    <!-- ===================================== 1.0.0 ===================================== -->

    <!-- Request Parser 1.0.0 -->
    <script>
        function InteractionRequestParser_1_0_0()
        {
            this.generator = null;
        }

        // Main entry point
        InteractionRequestParser_1_0_0.prototype.parse = function(request, generator)
        {
            this.generator = generator;

            this.generator.begin();

            this.parseTitle(request);

            var partCount = request.parts.length;
            for (var partIndex = 0; partIndex < partCount; partIndex++)
            {
                var part = request.parts[partIndex];

                switch (part.kind)
                {
                    case "static-text":
                        this.parseStaticText(request, part);
                        break;
                    case "text-input":
                        this.parseTextInput(request, part);
                        break;
                    case "choices":
                        this.parseChoices(request, part);
                        break;
                }
            }

            this.generator.end();
        };

        InteractionRequestParser_1_0_0.prototype.parseTitle = function(request)
        {
            var title = request.title;
            this.generator.generateTitle(title);
        };

        InteractionRequestParser_1_0_0.prototype.parseStaticText = function(request, part)
        {
            var id = part.id;
            var text = part.text;

            this.generator.generateStaticText(id, text);
        };

        InteractionRequestParser_1_0_0.prototype.parseTextInput = function(request, part)
        {
            var id = part.id;
            var label = part.label;
            var sensitive = part.sensitive;

            this.generator.generateTextInput(id, label, sensitive);
        };

        InteractionRequestParser_1_0_0.prototype.parseChoices = function(request, part)
        {
            var id = part.id;
            var label = part.label;

            var suggestedWidgetType = part.suggestedWidgetType;

            var defaultChoiceId = null;
            if (part.defaultChoiceId !== undefined)
                defaultChoiceId = part.defaultChoiceId;

            var choices = [];
            var choicesCount = part.choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = part.choices[choicesIndex];

                var choiceId = choice.id;
                var choiceLabel = choice.label;

                choices.push({id:choiceId, label:choiceLabel});
            }

            this.generator.generateChoices(id, label, choices, defaultChoiceId, suggestedWidgetType);
        };
    </script>


    <!-- Form Generator 1.0.0 -->
    <script>
        function InteractionFormGenerator_1_0_0(polymer, view, widgetMap, maxWidth)
        {
            this.polymer = polymer;
            this.rootView = view;
            this.widgetMap = widgetMap;
            this.maxWidth = maxWidth;

            this.commitButton = null;
        }

        InteractionFormGenerator_1_0_0.prototype.getResponse = function()
        {
            return this.response;
        };

        InteractionFormGenerator_1_0_0.prototype.clear = function()
        {
            // Clean up from the last time we used the root view
            this.rootView.removeEventListener('keyup', this.onKeyUp.bind(this));
            this.rootView.removeEventListener('paper-radio-group-changed', this.onPaperRadioGroupChanged.bind(this));
            this.rootView.removeEventListener('change', this.onChange.bind(this));

            if (this.cancelButton)
            {
                // this.cancelButton.removeEventListener('click', this.onCancelButtonClicked.bind(this));
                this.cancelButton = null;
            }

            if (this.commitButton)
            {
                // this.commitButton.removeEventListener('click', this.onCommitButtonClicked.bind(this));
                this.commitButton = null;
            }

            // Remove all children of the root view
            for (var child = Polymer.dom(this.rootView).lastChild;
                 child != null;
                 child = Polymer.dom(this.rootView).lastChild)
            {
                Polymer.dom(this.rootView).removeChild(child);
            }
            Polymer.dom.flush();

            // Clear the widget map
            for (var property in this.widgetMap)
            {
                if (this.widgetMap.hasOwnProperty(property))
                    delete this.widgetMap[property];
            }
        };

        InteractionFormGenerator_1_0_0.prototype.begin = function()
        {
            this.clear();

            this.generating = true;

            // Add listener to all user-input changes so we can validate the form and enable the "OK" button
            this.rootView.addEventListener('keyup', this.onKeyUp.bind(this));
            this.rootView.addEventListener('paper-radio-group-changed', this.onPaperRadioGroupChanged.bind(this));
            this.rootView.addEventListener('change', this.onChange.bind(this));

            this.rootView.style.minWidth = "300px";
            this.rootView.style.padding = "16px";
        };

        InteractionFormGenerator_1_0_0.prototype.end = function()
        {
            // Horizontal container for cancel and commit buttons
            var div = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(div);
            this.polymer.toggleClass("layout", true, div);
            this.polymer.toggleClass("horizontal", true, div);
            div.style.width = "100%";
            div.style.paddingTop = "20px";

            // Spacer to push button to right
            var springSpacer = document.createElement('div');
            Polymer.dom(div).appendChild(springSpacer);
            springSpacer.style.width = "100%";

            // Cancel button
            var cancelButton = document.createElement('paper-button');
            cancelButton.addEventListener('click', this.onButtonClicked.bind(this, true));
            Polymer.dom(div).appendChild(cancelButton);
            cancelButton.raised = true;
            cancelButton.style.width = "60px";
            cancelButton.style.height = "36px";
            cancelButton.style.background = "white";
            Polymer.dom(cancelButton).textContent = 'Cancel';
            this.cancelButton = cancelButton;

            // Spacer between buttons
            var spacer = document.createElement('div');
            Polymer.dom(div).appendChild(spacer);
            spacer.style.width = "20px";

            // Commit button
            var commitButton = document.createElement('paper-button');
            commitButton.addEventListener('click', this.onButtonClicked.bind(this, false));
            Polymer.dom(div).appendChild(commitButton);
            commitButton.raised = true;
            commitButton.style.width = "60px";
            commitButton.style.height = "36px";
            commitButton.style.background = "white";
            Polymer.dom(commitButton).textContent = 'OK';
            this.commitButton = commitButton;

            // Flush all changes
            Polymer.dom.flush();

            this.generating = false;

            this.validate();
        };

        InteractionFormGenerator_1_0_0.prototype.generateId = function(id)
        {
            // Ignore. No need to display this.
        };

        InteractionFormGenerator_1_0_0.prototype.generateTitle = function(title)
        {
            var element = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(element);
            element.innerHTML = title;
            element.style.paddingBottom = "10px";
            element.style.fontSize = "20pt;";
        };

        InteractionFormGenerator_1_0_0.prototype.generateStaticText = function(id, text)
        {
            var element = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(element);

            element.innerHTML = text;
            element.style.maxWidth = this.maxWidth;
            element.style.paddingTop = "12px";

            this.widgetMap[id] = element;
        };

        InteractionFormGenerator_1_0_0.prototype.generateTextInput = function(id, label, sensitive)
        {
            var element = document.createElement('paper-input');
            Polymer.dom(this.rootView).appendChild(element);

            element.label = label;
            element.style.paddingTop = "12px";

            var type;
            if (sensitive)
                type = 'password';
            else
                type = 'text';
            element.type = type;

            this.widgetMap[id] = element;
        };

        InteractionFormGenerator_1_0_0.prototype.generateChoices = function(id, label, choices, defaultChoiceId, suggestedWidgetType)
        {
            // Vertical container
            var container = document.createElement('div');
            Polymer.dom(this.rootView).appendChild(container);
            this.polymer.toggleClass("layout", true, container);
            this.polymer.toggleClass("vertical", true, container);
            container.style.width = "100%";
            container.style.paddingTop = "12px";

            // Create choice group
            switch (suggestedWidgetType)
            {
                // Short lists
                case "radiobutton":
                case "list-box":  // TODO
                default:
                    this.generateRadiobuttonChoices(id, label, choices, defaultChoiceId, container);
                    break;

                // Long lists
                case "combo-box":
                case "drop-down-menu":  // TODO
                    this.generateMenuChoices(id, label, choices, defaultChoiceId, container);
                    break;
            }
        };

        InteractionFormGenerator_1_0_0.prototype.generateRadiobuttonChoices = function(id, label, choices, defaultChoiceId, container)
        {
            // Group label
            var groupLabel = document.createElement('div');
            Polymer.dom(container).appendChild(groupLabel);
            groupLabel.innerHTML = label;
            groupLabel.style.maxWidth = this.maxWidth;
            groupLabel.style.marginBottom = "12px";
            groupLabel.style.paddingTop = "12px";

            // Group
            var group = document.createElement('paper-radio-group');
            group.id = "choice-group";
            Polymer.dom(container).appendChild(group);
            group.style.maxWidth = this.maxWidth;
            this.widgetMap[id] = group;

            // Choices in group
            var choicesCount = choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = choices[choicesIndex];

                // Radiobutton
                var radiobutton = document.createElement('paper-radio-button');
                Polymer.dom(group).appendChild(radiobutton);
                radiobutton.id = choice.id;
                radiobutton.name = choice.id;
                Polymer.dom(radiobutton).textContent = choice.label;
                radiobutton.style.paddingLeft = "20px";

                // If a default choice was specified and this is it, select this radiobutton
                if (defaultChoiceId && radiobutton.id == defaultChoiceId)
                    group.select(choice.id);

                this.widgetMap[choice.id] = radiobutton;
            }
        };

        InteractionFormGenerator_1_0_0.prototype.generateMenuChoices = function(id, label, choices, defaultChoiceId, container)
        {
            // Dropdown menu
            var dropdownMenu = document.createElement('select');
            Polymer.dom(container).appendChild(dropdownMenu);
            dropdownMenu.style.maxWidth = this.maxWidth;
            dropdownMenu.style.paddingTop = "12px";
            dropdownMenu.label = label;
            this.widgetMap[id] = dropdownMenu;

            // Items
            var choicesCount = choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = choices[choicesIndex];

                var item = document.createElement('option');
                Polymer.dom(dropdownMenu).appendChild(item);
                item.value = choice.id;
                item.text = choice.label;

                // If a default choice was specified and this is it, select this item
                if (defaultChoiceId && item.value == defaultChoiceId)
                    dropdownMenu.value = item.value;

                this.widgetMap[choice.id] = null;  // Unlike radiobutton clusters, there is no widget for each menu choice
            }
        };

        InteractionFormGenerator_1_0_0.prototype.onButtonClicked = function(event, cancels)
        {
            this.fire(this.rootView, 'button-clicked');
        };

        InteractionFormGenerator_1_0_0.prototype.onKeyUp = function(event)
        {
            this.onUserInput();
        };

        InteractionFormGenerator_1_0_0.prototype.onPaperRadioGroupChanged = function(event)
        {
            this.onUserInput();
        };

        InteractionFormGenerator_1_0_0.prototype.onChange = function(event)
        {
            this.onUserInput();
        };

        InteractionFormGenerator_1_0_0.prototype.onUserInput = function()
        {
            // Suppress when we are compiling
            if (this.generating)
                return;

            this.validate();

            this.fire(this.rootView, 'entered-data-changed');
        };

        InteractionFormGenerator_1_0_0.prototype.validate = function()
        {
            if (this.commitButton == null)
                return;

            var enabled = true;

            if (enabled)
                enabled = this.allTextInputsValid();
            if (enabled)
                enabled = this.allRadiobuttonGroupsValid();
            if (enabled)
                enabled = this.allMenusValid();

            this.commitButton.disabled = !enabled;
        };

        InteractionFormGenerator_1_0_0.prototype.allTextInputsValid = function()
        {
            // For each text input in the form
            var elements = Polymer.dom(this.rootView).querySelectorAll("paper-input");
            var count = elements.length;
            for (var index = 0; index < count; index++)
            {
                var element = elements[index];
                if (element.value.length == 0)
                    return false;
            }
            return true;
        };

        InteractionFormGenerator_1_0_0.prototype.allRadiobuttonGroupsValid = function()
        {
            // For each radiobutton group in the form
            var radioButtonGroups = Polymer.dom(this.rootView).querySelectorAll("#choice-group");
            var groupCount = radioButtonGroups.length;
            for (var groupIndex = 0; groupIndex < groupCount; groupIndex++)
            {
                var radioButtonGroup = radioButtonGroups[groupIndex];

                // Is one of the radiobuttons in this group selected?
                var someRadiobuttonIsSelected = false;
                var radiobuttons = Polymer.dom(radioButtonGroup).querySelectorAll("paper-radio-button");
                var radiobuttonCount = radiobuttons.length;
                for (var radiobuttonIndex = 0; radiobuttonIndex < radiobuttonCount; radiobuttonIndex++)
                {
                    var radioButton = radiobuttons[radiobuttonIndex];
                    if (radioButton.checked)
                    {
                        someRadiobuttonIsSelected = true;
                        break;
                    }
                }
                if (!someRadiobuttonIsSelected)
                    return false;
            }
            return true;
        };

        InteractionFormGenerator_1_0_0.prototype.allMenusValid = function()
        {
            // For each menu in the form
            var menus = Polymer.dom(this.rootView).querySelectorAll("select");
            var count = menus.length;
            for (var index = 0; index < count; index++)
            {
                var menu = menus[index];
                if (menu.value == null)
                    return false;
            }
            return true;
        };

        InteractionFormGenerator_1_0_0.prototype.fire = function(element, eventName)
        {
            var event;

            if (document.createEvent)
            {
                event = document.createEvent("HTMLEvents");
                event.initEvent(eventName, true, true);
            }
            else
            {
                event = document.createEventObject();
                event.eventType = eventName;
            }

            event.eventName = eventName;

            if (document.createEvent)
                element.dispatchEvent(event);
            else
                element.fireEvent("on" + event.eventType, event);
        };    </script>


    <!-- Response Generator 1.0.0 -->
    <script>
        function InteractionResponseGenerator_1_0_0(widgetMap)
        {
            this.widgetMap = widgetMap;

            this.responseParts = null;

            this.response = null;
        }

        InteractionResponseGenerator_1_0_0.prototype.getResponse = function()
        {
            return this.response;
        };

        InteractionResponseGenerator_1_0_0.prototype.begin = function()
        {
            this.responseParts = [];
        };

        InteractionResponseGenerator_1_0_0.prototype.end = function()
        {
            this.response =
            {
                "version": "1.0.0",
                "id": this.requestId.toString(),
                "parts": this.responseParts
            };
        };

        InteractionResponseGenerator_1_0_0.prototype.generateId = function(id)
        {
            this.requestId = id;
        };

        InteractionResponseGenerator_1_0_0.prototype.generateTitle = function(title)
        {
            // Nothing to do
        };

        InteractionResponseGenerator_1_0_0.prototype.generateStaticText = function(id, text)
        {
            // Nothing to do
        };

        InteractionResponseGenerator_1_0_0.prototype.generateTextInput = function(id, label, sensitive)
        {
            var field = this.widgetMap[id];
            var value = field.value;

            this.responseParts.push({id:id, value:value});
        };

        InteractionResponseGenerator_1_0_0.prototype.generateChoices = function(id, label, choices, defaultChoiceId, suggestedWidgetType)
        {
            var group = this.widgetMap[id];

            switch (suggestedWidgetType)
            {
                // Short lists
                case "radiobutton":
                case "list-box":  // TODO
                default:
                    group = this.generateRadiobuttonChoices(id, label, choices);
                    break;

                // Long lists
                case "combo-box":
                case "drop-down-menu":  // TODO
                    group = this.generateMenuChoices(id, label, choices);
                    break;
            }
        };

        // Private
        InteractionResponseGenerator_1_0_0.prototype.generateRadiobuttonChoices = function(id, label, choices)
        {
            var group = this.widgetMap[id];

            // Find the selected choice
            var choicesCount = choices.length;
            for (var choicesIndex = 0; choicesIndex < choicesCount; choicesIndex++)
            {
                var choice = choices[choicesIndex];
                var choiceId = choice.id;
                var radiobutton = this.widgetMap[choiceId];
                if (radiobutton.checked)
                {
                    this.responseParts.push({id:id, value:choiceId});
                    return;
                }
            }
        };

        // Private
        InteractionResponseGenerator_1_0_0.prototype.generateMenuChoices = function(id, label, choices)
        {
            var menu = this.widgetMap[id];
            var choiceId = menu.value;

            this.responseParts.push({id:id, value:choiceId});
        };
    </script>


    <script>
        Polymer
        ({
            is: 'ft-user-interaction-form',

            /**
             * Fired when the request property changes.
             *
             * @event requestChanged
             */

            /**
             * Fired when the response property changes.
             *
             * @event responseChanged
             */

            /**
             * Fired when any data on the form is changed by the user —text entry, radiobutton, etc.
             *
             * @event enteredDataChanged
             */

            /**
             * Fired a pushbutton is clicked by the user on the form.
             *
             * @event buttonClicked
             */

            properties:
            {
                /** Version of user interaction schema to use. */
                version:
                {
                    type: String,  // JSON
                    notify: true,
                    value: "2.0.0",
                    observer: "_onVersionChanged"
                },

                /** User interaction request as JSON, to be rendered as a form. */
                request:
                {
                    type: String,  // JSON
                    notify: true,
                    value: null,
                    observer: "_onRequestChanged"
                },

                /** User interaction response as JSON, extracted from data entered into the form. */
               response:
                {
                    type: String,  // JSON
                    notify: true,
                    value: null,
                    observer: "_onResponseChanged"
                }
            },

            _requestParser: null,
            _formGenerator: null,
            _responseGenerator: null,
            _widgetMap: {},

            _onVersionChanged: function()
            {
                switch (this.version)
                {
                    case "1.0.0":
                        this._requestParser = new InteractionRequestParser_1_0_0();
                        this._formGenerator = new InteractionFormGenerator_1_0_0(this, this.$.form, this._widgetMap, "325px");
                        this._responseGenerator = new InteractionResponseGenerator_1_0_0(this._widgetMap);
                        break;

                    case "2.0.0":
                        this._requestParser = new InteractionRequestParser_2_0_0();
                        this._formGenerator = new InteractionFormGenerator_2_0_0(this, this.$.form, this._widgetMap, "325px");
                        this._responseGenerator = new InteractionResponseGenerator_2_0_0(this._widgetMap);
                        break;

                    default:
                        throw new IllegalArgumentException("Unknown user interaction schema version: " + this.version);
                }
            },

            _onRequestChanged: function()
            {
                this._generateForm();
                this._clearResponse();
                this.fire('requestChanged');
            },

            _onResponseChanged: function()
            {
                this.fire('responseChanged');
            },

            _clearResponse: function()
            {
                this.response = null;
            },

            _generateForm: function()
            {
                if (this._formGenerator == null)
                    return;
                if (this.request == null)
                    this._formGenerator.clear();
                else
                    this._requestParser.parse(this.request, this._formGenerator);
            },

            /** You may call this at will to generate a partial response from what has been entered in the form, so far */
            generateResponse: function()
            {
                if (this._responseGenerator == null)
                    return;
                this._requestParser.parse(this.request, this._responseGenerator);
                this.response = this._responseGenerator.getResponse();
            },

            _onEnteredDataChanged: function(event)
            {
                this.fire('enteredDataChanged');
            },

            _onButtonClicked: function(event, detail)
            {
                // If not cancel, generate response.

                this.generateResponse();

                this.fire('buttonClicked');
            }

        });
    </script>

</dom-module>
